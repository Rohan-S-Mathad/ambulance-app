"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPaginatedResource = void 0;
const debug_1 = __importDefault(require("debug"));
const error_1 = require("../../utils/error");
const log = (0, debug_1.default)('twilio-serverless-api:utils:pagination');
async function getPaginatedResource(client, url, opts = { responseType: 'json' }) {
    let result = [];
    opts = {
        ...opts,
    };
    let nextPageUrl = url;
    do {
        try {
            if (nextPageUrl.startsWith('http')) {
                opts.prefixUrl = '';
            }
            const resp = await client.request('get', nextPageUrl, opts);
            const body = resp.body;
            nextPageUrl = body.meta.next_page_url;
            const entries = body[body.meta.key];
            result = [...result, ...entries];
        }
        catch (err) {
            log('%O', new error_1.ClientApiError(err));
            // if the first request failed, throw error
            if (nextPageUrl === url) {
                throw err;
            }
            else {
                break;
            }
        }
    } while (nextPageUrl !== null);
    return result;
}
exports.getPaginatedResource = getPaginatedResource;
