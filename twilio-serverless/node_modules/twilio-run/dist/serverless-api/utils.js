"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.saveLatestDeploymentData = exports.getFunctionServiceSid = void 0;
const global_1 = require("../config/global");
const deployInfoCache_1 = require("../utils/deployInfoCache");
const logger_1 = require("../utils/logger");
const debug = (0, logger_1.getDebugFunction)('twilio-run:internal:utils');
async function getFunctionServiceSid(cwd, configName, commandConfig, username, region = 'us1') {
    var _a, _b;
    const twilioConfig = (0, global_1.readSpecializedConfig)(cwd, configName, commandConfig, {
        username,
        region,
    });
    if (twilioConfig.serviceSid) {
        debug('Found serviceSid in config, "%s"', twilioConfig.serviceSid);
        return twilioConfig.serviceSid;
    }
    if (username) {
        debug('Attempting to read serviceSid from a deployinfo file');
        const deployInfoCache = (0, deployInfoCache_1.getDeployInfoCache)(cwd);
        if ((_a = deployInfoCache[`${username}:${region}`]) === null || _a === void 0 ? void 0 : _a.serviceSid) {
            debug('Found service sid by region from deploy info, "%s"', deployInfoCache[`${username}:${region}`].serviceSid);
            return deployInfoCache[`${username}:${region}`].serviceSid;
        }
        if ((_b = deployInfoCache[username]) === null || _b === void 0 ? void 0 : _b.serviceSid) {
            debug('Found service sid from deploy info, "%s"', deployInfoCache[username].serviceSid);
            return deployInfoCache[username].serviceSid;
        }
    }
    debug('Could not determine existing serviceSid');
    debug(`${username}:${region}`);
    return undefined;
}
exports.getFunctionServiceSid = getFunctionServiceSid;
async function saveLatestDeploymentData(cwd, serviceSid, buildSid, username, region) {
    if (!username) {
        return;
    }
    return (0, deployInfoCache_1.updateDeployInfoCache)(cwd, username, region, {
        serviceSid,
        latestBuild: buildSid,
    });
}
exports.saveLatestDeploymentData = saveLatestDeploymentData;
